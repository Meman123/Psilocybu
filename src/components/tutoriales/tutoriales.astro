---
import { Icon } from 'astro-icon/components';

interface Video {
  id: string;
  dur: string;
  title: string;
  thumb: string;
}

const videos: Video[] = [
  { id: '1072553822', dur: '1:45', title: 'Unboxing y preparación',   thumb: 'https://i.vimeocdn.com/video/2001538867-91a68f149692c41e46e2c3bb7e42b427ccaec08cee7b3a0e9b8eac62964f21d1-d_640?region=us' },
  { id: 'VIDEO_ID_2',   dur: '2:30', title: 'Cuidados y fructificación', thumb: 'https://i.vimeocdn.com/video/2001538867-91a68f149692c41e46e2c3bb7e42b427ccaec08cee7b3a0e9b8eac62964f21d1-d_640?region=us' },
  { id: 'VIDEO_ID_3',   dur: '3:15', title: 'Cosecha y secado',          thumb: 'https://i.vimeocdn.com/video/2001538867-91a68f149692c41e46e2c3bb7e42b427ccaec08cee7b3a0e9b8eac62964f21d1-d_640?region=us' },
  { id: 'VIDEO_ID_4',   dur: '1:00', title: 'Solución de problemas',     thumb: 'https://i.vimeocdn.com/video/2001538867-91a68f149692c41e46e2c3bb7e42b427ccaec08cee7b3a0e9b8eac62964f21d1-d_640?region=us' },
];
---

<style>
:root {
  --color-background-soft: hsla(59 100% 67% / .4);
  --radius-large: 16px;
}

/* ====== SECCIÓN PRINCIPAL ====== */
.tutorials { background: var(--color-background-soft); padding-block: var(--spacing-xl); overflow: hidden; }
.tutorials__container { max-width: var(--site-max-width); margin:auto; padding-inline:var(--side-gutter); display:flex; flex-direction:column; gap:var(--spacing-lg); text-align:center; }

.tutorials__headline { font:clamp(2.3rem,4.5vw,3.5rem)/1.1 var(--font-family-base); font-weight:var(--font-weight-bold); }
.tutorials__sub      { font-size:1.2rem; max-width:80ch; margin:auto; font-weight:500; }
.tutorials__alert    { background:var(--color-accent); color:#000; padding:var(--spacing-sm) var(--spacing-md); border-radius:var(--border-radius-medium); font-weight:var(--font-weight-semibold); }
.tutorials__alert a  { text-decoration:underline; color:inherit; }

/* ====== LISTA / GRID ====== */
.tutorials__scroll-container { display:flex; overflow-x:auto; gap:var(--spacing-md); padding-block:var(--spacing-lg); margin-inline:calc(-1*var(--side-gutter)); padding-inline:var(--side-gutter); scrollbar-width:none; }
.tutorials__scroll-container::-webkit-scrollbar { display:none; }

/* ====== CARD DE VIDEO ====== */
.video-card { flex-shrink:0; width:clamp(280px,70vw,320px); aspect-ratio:16/9; border-radius:var(--radius-large); overflow:hidden; position:relative; background:var(--color-background); border:1px solid hsl(0 0% 0%/.1); box-shadow:0 2px 6px hsl(0 0% 0%/.08); transition:transform .2s,box-shadow .2s; cursor:pointer; }
.video-card:hover { transform:translateY(-4px); box-shadow:0 6px 18px hsl(0 0% 0%/.15); }
.video-card__thumb          { width:100%; height:100%; object-fit:cover; transition:transform .4s; }
.video-card:hover .video-card__thumb { transform:scale(1.1); }

.video-card__overlay { position:absolute; inset:0; display:flex; flex-direction:column; justify-content:space-between; padding:var(--spacing-md); background:linear-gradient(to top,#fffc5531 0%,transparent 40%); }
.video-card__play-icon { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:3rem; filter:drop-shadow(0 2px 4px hsl(0 0% 0%/.5)); transition:transform .3s; }
.video-card:hover .video-card__play-icon { transform:translate(-50%,-50%) scale(1.15); }
.video-card__title    { font-weight:var(--font-weight-bold); font-size:1.1rem; line-height:1.3; color:#000; }
.video-card__duration { margin-top:4px; font-size:.8rem; background:hsl(0 0% 0%/.5); color:#fff; padding:2px 8px; border-radius:99px; }

/* ====== CTA ====== */
.tutorials__cta { align-self:center; padding:12px 32px; border-radius:99px; font-weight:var(--font-weight-bold); background:var(--color-accent); color:#000; border:none; display:inline-flex; gap:8px; box-shadow:0 4px 8px hsl(0 0% 0%/.12); transition:transform .25s,box-shadow .25s; text-decoration:none; }
.tutorials__cta:hover { transform:translateY(-2px) scale(1.04); box-shadow:0 6px 14px hsl(0 0% 0%/.18); }

/* ====== MODAL ====== */
dialog.video-modal { border:none; padding:0; background:transparent; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
dialog.video-modal::backdrop { background:hsl(0 0% 0%/.55); backdrop-filter:blur(8px); }

/* contenedor e iframe sin absolutamente ningún borde/outline/shadow */
.modal-content, dialog.video-modal, .modal-content iframe {
  margin:0;
  padding:0;
  border:none !important;
  outline:none !important;
  box-shadow:none !important;
  background:none !important;
}

.modal-content { 
  width:min(90vw,1600px);
  aspect-ratio:16/9;
  max-height:90vh;
  display:flex;
  line-height:0;    /* elimina el gap base-line */
}
.modal-content iframe { 
  width:100%;
  height:100%;
  display:block;    /* quita el inline-gap */
}

/* botón de cierre */
.modal-close { position:absolute; top:24px; right:24px; width:48px; height:48px; border:none; border-radius:50%; background:hsl(0 0% 0%/.6); color:#fff; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px); transition:transform .3s, background .3s; }
.modal-close:hover   { background:var(--color-accent); color:#000; transform:rotate(90deg) scale(1.08); }
.modal-close:focus-visible { outline:2px solid var(--color-accent); outline-offset:2px; }

/* ====== GRID EN DESKTOP ====== */
@media (min-width:768px){ .tutorials__scroll-container{display:grid;grid-template-columns:repeat(2,1fr);margin-inline:0;padding-inline:0;} }
@media (min-width:1024px){ .tutorials__scroll-container{grid-template-columns:repeat(3,1fr);} .video-card__play-icon{font-size:4rem;} }
@media (min-width:1400px){ .tutorials__scroll-container{grid-template-columns:repeat(4,1fr);} }
</style>

<section class="tutorials" id="tutorials">
  <div class="tutorials__container">
    <h2 class="tutorials__headline">Aprende paso a paso</h2>
    <p class="tutorials__sub">
      PSILOCYBU GrowKit® contiene 1 L de micelio albino Averys listo para fructificar. 
      Es muy sensible a la contaminación; sigue cada paso del video para evitar pérdidas 
      y conoce nuestra política de garantía.
    </p>

    <div class="tutorials__alert">
      Lee las instrucciones antes de abrir tu kit · <a href="/garantia">Revisa nuestra política de garantía</a>
    </div>

    <div class="tutorials__scroll-container">
      {videos.map((video) => (
        <button
          class="video-card"
          data-video-id={video.id}
          data-video-title={video.title}
          aria-label={`Reproducir video: ${video.title}`}
        >
          <img class="video-card__thumb" src={video.thumb} alt={`Miniatura: ${video.title}`} loading="lazy" width="320" height="180" />
          <div class="video-card__overlay" aria-hidden="true">
            <div>
              <h3 class="video-card__title">{video.title}</h3>
              <span class="video-card__duration">{video.dur}</span>
            </div>
            <div class="video-card__play-icon">
              <Icon name="mdi:play-circle" width="80" />
            </div>
          </div>
        </button>
      ))}
    </div>

    <a href="/tutoriales" class="tutorials__cta">
      Ver más tutoriales <Icon name="mdi:arrow-right" width="20" />
    </a>
  </div>

  <dialog class="video-modal" id="videoModal">
    <div class="modal-content"></div>
    <button class="modal-close" aria-label="Cerrar video">
      <Icon name="mdi:close" width="28" />
    </button>
  </dialog>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('videoModal');
      if (!(modal instanceof HTMLDialogElement)) return;

      const modalContent = modal.querySelector('.modal-content');
      const closeBtn = modal.querySelector('.modal-close');
      const videoCards = document.querySelectorAll('.video-card');
      if (!modalContent || !closeBtn) return;

      const createVimeoIframe = (id: string, title: string) => {
        const iframe = document.createElement('iframe');
        const isMobile = window.matchMedia('(pointer:coarse)').matches;
        const playsinline = isMobile ? 0 : 1;
        iframe.src = `https://player.vimeo.com/video/${id}?autoplay=1&responsive=1&playsinline=${playsinline}&controls=1&title=0&byline=0&portrait=0&dnt=1&autopause=0`;
        iframe.title = `Video: ${title}`;
        iframe.allow = 'autoplay; fullscreen; picture-in-picture';
        iframe.setAttribute('allowfullscreen', '');
        iframe.width = '100%';
        iframe.height = '100%';
        iframe.loading = 'lazy';
        return iframe;
      };

      const openModal = (btn: HTMLButtonElement) => {
        const { videoId, videoTitle } = btn.dataset;
        if (!videoId || !videoTitle) return;
        modalContent.innerHTML = '';
        modalContent.appendChild(createVimeoIframe(videoId, videoTitle));
        modal.showModal();
        document.body.style.overflow = 'hidden';
      };

      const closeModal = () => modal.close();

      videoCards.forEach(card => card.addEventListener('click', () => openModal(card as HTMLButtonElement)));
      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
      modal.addEventListener('close', () => {
        modalContent.innerHTML = '';
        document.body.style.overflow = '';
      });
    });
  </script>
</section>
