---
/* Dosificador Villa de Leyva ‚Äî versi√≥n ‚Äúoption-cards‚Äù final (l√≥gica revisada 2025-07-17) */
---
<style>
/* ===== SECCI√ìN PRINCIPAL ===== */
.dosage{
  background:var(--color-background-alt);
  padding-block:var(--spacing-xl);
}
.dosage__container{
  max-width:var(--site-max-width);
  margin-inline:auto;
  padding-inline:var(--side-gutter);
  display:flex;flex-direction:column;gap:var(--spacing-lg);
}
.dosage__headline{
  font:clamp(1.3rem,4vw,3rem)/1.1 var(--font-family-headings,'Quicksand');
  font-weight:700;text-align:center;
}

/* ===== FORMULARIO ===== */
.dosage__form{display:grid;gap:var(--spacing-lg);grid-template-columns:1fr;}
.field{display:flex;flex-direction:column;gap:var(--spacing-sm);}

/* Peso (input num√©rico) */
.input-number{
  display:flex;align-items:stretch;background:var(--color-background);
  border:1px solid var(--color-border);border-radius:var(--border-radius-medium);
  overflow:hidden;
}
.input-number__btn{
  width:48px;background:var(--color-accent);border:none;font-size:1.5rem;font-weight:700;
  cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s;
}
.input-number__btn:hover{background:#fffdb0;}
.input-number input{
  flex:1;border:none;text-align:center;font-size:1.15rem;padding-block:var(--spacing-sm);
}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}
input[type=number]{-moz-appearance:textfield;}
.input-number input:focus-visible{outline:2px solid var(--color-accent);outline-offset:2px;}

/* ===== OPTION-CARDS ===== */
.options-grid{
  display:grid;gap:var(--spacing-md);
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
}
.option-card{
  position:relative;user-select:none;cursor:pointer;text-align:center;
  padding:var(--spacing-md) var(--spacing-sm);
  border:1.5px solid var(--color-border);border-radius:var(--border-radius-medium);
  background:var(--color-background);display:flex;flex-direction:column;align-items:center;gap:var(--spacing-xs);
  transition:border-color .15s,background .15s,transform .15s,box-shadow .15s;
}
.option-card__icon{font-size:1.9rem;line-height:1;}
.option-card__label{font-weight:500;font-size:.95rem;}

/* Ocultamos totalmente el radio */
.option-card input{
  position:absolute;inset:0;opacity:0;pointer-events:none;
}

/* Feedback de selecci√≥n */
.option-card:has(input:checked){
  border-color:var(--color-accent);
  background:color-mix(in srgb,var(--color-accent) 50%,transparent);
  box-shadow:0 3px 10px hsl(0 0% 0%/.12);
  transform:translateY(-2px);
}

/* ===== RESULTADO ===== */
.result-output{
  font-size:1.8rem;font-weight:700;background:var(--color-background);
  border:1px solid var(--color-border);border-radius:var(--border-radius-medium);
  padding:var(--spacing-sm) var(--spacing-md);width:100%;text-align: center;
}
.note{font-size:.85rem;color:var(--color-border);}

/* ===== RESPONSIVE ===== */
@media (min-width:768px){
  .result-output{font-size:2.2rem;}
}
</style>

<section class="dosage" id="dosage">
  <div class="dosage__container">
    <h2 class="dosage__headline">Dosificador&nbsp;Villa&nbsp;de&nbsp;Leyva</h2>

    <form class="dosage__form" id="dosageForm" autocomplete="off">
      <!-- 1 ¬∑ Peso -->
      <div class="field">
        <label for="weightInput"><strong>1 ¬∑ Tu peso (kg)</strong></label>
        <div class="input-number">
          <button type="button" class="input-number__btn" data-action="decrement" aria-label="Disminuir peso">‚àí</button>
          <input id="weightInput" type="number" min="20" max="200" step="1" value="70" required />
          <button type="button" class="input-number__btn" data-action="increment" aria-label="Incrementar peso">Ôºã</button>
        </div>
      </div>

      <!-- 2 ¬∑ Estado setas -->
      <div class="field">
        <span><strong>2 ¬∑ Estado de las setas</strong></span>
        <div class="options-grid">
          <label class="option-card">
            <input type="radio" name="state" value="dry" checked />
            <span class="option-card__icon">üçÑ</span>
            <span class="option-card__label">Secas</span>
          </label>
          <label class="option-card">
            <input type="radio" name="state" value="fresh" />
            <span class="option-card__icon">üíß</span>
            <span class="option-card__label">Frescas</span>
          </label>
        </div>
      </div>

      <!-- 3 ¬∑ Tipo dosis -->
      <div class="field">
        <span><strong>3 ¬∑ Tipo de dosis</strong></span>
        <div class="options-grid">
          <label class="option-card">
            <input type="radio" name="doseType" value="micro" checked />
            <span class="option-card__icon">üå±</span>
            <span class="option-card__label">Micro</span>
          </label>
          <label class="option-card">
            <input type="radio" name="doseType" value="baja" />
            <span class="option-card__icon">üçÉ</span>
            <span class="option-card__label">Baja</span>
          </label>
          <label class="option-card">
            <input type="radio" name="doseType" value="media" />
            <span class="option-card__icon">üçÑ</span>
            <span class="option-card__label">Media</span>
          </label>
          <label class="option-card">
            <input type="radio" name="doseType" value="alta" />
            <span class="option-card__icon">üöÄ</span>
            <span class="option-card__label">Alta</span>
          </label>
        </div>
      </div>

      <!-- 4 ¬∑ Resultado -->
      <div class="field">
        <label><strong>4 ¬∑ Dosis recomendada (g)</strong></label>
        <output id="doseOutput" class="result-output" for="weightInput">0,20</output>
        <span class="note">* Valor estimado. Ajusta seg√∫n tu experiencia y tolerancia.</span>
      </div>
    </form>
  </div>
</section>

<!-- ===== JS PURO (l√≥gica revisada) ===== -->
<script is:inline>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('dosageForm');
  if (!form) return;

  const weightInput = form.querySelector('#weightInput');
  const doseOutput  = form.querySelector('#doseOutput');
  const stepBtns    = form.querySelectorAll('.input-number__btn');
  if (!weightInput || !doseOutput) return;

  /* 
    Tabla orientativa para Psilocybe cubensis SECAS.
    Valores en gramos: l√≠mites conservadores basados en gu√≠as de reducci√≥n de riesgos.
    base = punto medio; min/max = rango permitido en categor√≠a.
  */
  const DOSE_TABLE = {
    micro:{min:0.10,base:0.20,max:0.30},
    baja: {min:0.80,base:1.25,max:1.50},
    media:{min:1.50,base:2.25,max:3.00},
    alta: {min:3.00,base:4.00,max:5.00},
  };

  /* Conversi√≥n aproximada fresco‚Üíseco (~90% agua) */
  const FRESH_MULT = 10;

  /* Ajuste suave por peso (adultos 20‚Äì200 kg); ref=70 kg; clamp 0.75‚Äì1.25 */
  function weightFactor(kg){
    const f = kg / 70;
    return Math.max(0.75, Math.min(1.25, f));
  }

  /* Calcula gramos secos recomendados para categor√≠a + peso */
  function calcDry(doseType, kg){
    const t = DOSE_TABLE[doseType];
    if(!t) return 0;
    const raw = t.base * weightFactor(kg);
    return Math.min(t.max, Math.max(t.min, raw));
  }

  function calc () {
    const w = parseFloat(weightInput.value) || 0;
    const state = form.querySelector('input[name="state"]:checked')?.value;
    const type  = form.querySelector('input[name="doseType"]:checked')?.value;
    if (!state || !type) return 0;
    let g = calcDry(type, w);
    if (state === 'fresh') g *= FRESH_MULT;
    doseOutput.textContent = g.toFixed(2).replace('.', ',');
    return g;
  }

  stepBtns.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const delta = btn.dataset.action==='increment'?1:-1;
      const curr  = parseInt(weightInput.value||'0',10);
      const next  = Math.max(20,Math.min(200,curr+delta));
      weightInput.value = String(next);
      calc();
    });
  });

  form.addEventListener('input', calc);
  calc();
});
</script>
